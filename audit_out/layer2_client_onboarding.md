# Layer 2 Audit – Client Onboarding & Approval Workflow

## Scope
Assessment of client self-registration, validation, approval workflow, provisioning, and UX/readiness relative to the requested onboarding model (TIN-anchored institutions with multi-contact support and supervisor approval).

## Current Capabilities
- **Client self-registration capture**: `/auth/client/register` exposes a form that validates 10-digit TINs, captures institution metadata (region/zone/city/subcity/woreda/kebele/street/house number/GPS hint), contact details, notes, and stores hashed portal passwords as `ClientRegistration` records marked `pending`. Duplicate TINs per org are blocked and existing accounts short-circuit to login.【F:erp/routes/auth.py†L88-L233】【F:erp/models/core_entities.py†L350-L383】
- **Duplicate email guardrails & audit trail**: Pending registrations are now deduplicated by email per org, preventing repeated submissions while awaiting approval, and successful submissions record an audit entry tagging the org/TIN/email for oversight.【F:erp/routes/auth.py†L176-L233】
- **Approval UI for admins/managers**: The user management page lists pending client registrations with approve/reject buttons, supporting manual review and notes.【F:erp/templates/user_management/index.html†L71-L109】
- **Approval logic & provisioning**: `/user_management/clients/<id>/approve` (admin/manager roles) promotes a pending registration into an `Institution` and a `ClientAccount`, reusing captured password hashes when provided, assigns the `client` role, and stamps decision metadata. Reject marks status rejected with actor/timestamp audit fields.【F:erp/user_management/__init__.py†L62-L150】
- **Role-aware routing hooks**: Legacy compatibility shims expose approval endpoints to existing paths, and `require_roles` guards approval/rejection, preventing non-admin/manager access.【F:erp/blueprints/compat_shims.py†L41-L50】【F:erp/user_management/__init__.py†L62-L150】

## Gaps & Risks vs. Requirements
- **Single-contact per TIN**: The data model accepts one contact per registration and one `ClientAccount` per email; there is no first-class support for multiple approved contacts under a TIN/institution or a UI to manage them.【F:erp/models/core_entities.py†L350-L383】【F:erp/user_management/__init__.py†L94-L129】
- **Supervisor vs. admin separation**: Approvals are limited to `admin`/`manager`; there is no explicit supervisor role distinction or secondary approval queue, and no MFA enforcement at approval time, despite elevated risk.【F:erp/user_management/__init__.py†L81-L150】
- **Geo-capture missing**: Registration and approval flows do not record geolocation for submissions or reviewer actions, conflicting with geo-audit expectations for client access events.【F:erp/routes/auth.py†L191-L233】【F:erp/user_management/__init__.py†L94-L150】
- **UI/UX modernization**: The approval table is basic Bootstrap with no responsive filters, search, sorting, or context (documents, history). There is no client-facing status tracker or CTA guiding unregistered emails to registration from login—requirements call for modern UX and clear status visibility.【F:erp/templates/user_management/index.html†L1-L150】【F:erp/routes/auth.py†L191-L233】
- **Institution uniqueness & lifecycle**: TIN uniqueness is enforced per org on `client_registrations`, but approval creates `Institution` records without an explicit unique constraint on TIN per org (relies on query), risking duplicates on concurrent approvals. Deletion/rejection does not clear staged password hashes or track who reviewed in an immutable audit log.【F:erp/models/core_entities.py†L350-L383】【F:erp/user_management/__init__.py†L94-L150】
- **No SLA/escalation**: Pending registrations have no aging SLA, reminders, or escalation path; approvals rely on manual page views without notifications or queues.【F:erp/user_management/__init__.py†L62-L150】

## Recommendations
1. **Model multi-contact institutions**: Introduce `InstitutionContact` linked to `Institution` (TIN-unique per org) with approval status, allowing multiple contacts per institution and role-specific access. Enforce unique `(org_id, tin)` on `institutions` and add database constraints for contact emails per institution.【F:erp/models/core_entities.py†L350-L383】
2. **Supervisor workflow & MFA**: Define a `supervisor` role separate from `admin`; require supervisor approval for new clients and MFA confirmation for approve/reject actions. Add dual-control or second approver for privileged institutions (finance/healthcare).【F:erp/user_management/__init__.py†L81-L150】
3. **Geo-audit trail**: Capture optional geolocation on registration and approval (request metadata/IP-derived geo), persist to audit tables, and surface in the approval UI for compliance with access-geo requirements.【F:erp/routes/auth.py†L191-L233】【F:erp/user_management/__init__.py†L94-L150】
4. **UX overhaul**: Modernize login/registration to route unrecognized emails to the registration form with prefill hints; add status tracking, search/filter/sort on approvals, bulk actions, and contextual info (history, documents). Provide accessible feedback, skeleton/loading states, and responsive layouts.【F:erp/templates/user_management/index.html†L1-L150】【F:erp/routes/auth.py†L191-L233】
5. **Operational rigor**: Add SLA timers and reminders for pending approvals, webhook/notification hooks, and immutable audit logs capturing approver, MFA proof, IP/geo, and decision notes. Prevent duplicate `Institution` creation with DB-level unique constraints and idempotent approval handlers.【F:erp/models/core_entities.py†L350-L383】【F:erp/user_management/__init__.py†L94-L150】
6. **Security & data hygiene**: Ensure password hashes from pending registrations are rotated on approval if older than a configurable window; scrub or encrypt stored notes/PII; validate phone/email formats consistently; and guard approval endpoints with CSRF and rate limiting aligned to security baselines.【F:erp/routes/auth.py†L191-L233】【F:erp/user_management/__init__.py†L94-L150】
