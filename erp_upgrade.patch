*** Begin Patch
*** Update File: erp/security.py
@@
-def require_roles(*role_names: str) -> Callable[[F], F]:
+def require_roles(*role_names: str) -> Callable[[F], F]:
@@
-    normalized = {r.strip() for r in role_names if r and r.strip()}
+    # Normalize role names to lowercase to support case-insensitive role checks
+    normalized = {r.strip().lower() for r in role_names if r and r.strip()}
@@
-            if normalized and not (user_role_names & normalized):
-                abort(403)
+            # Lower-case user roles to perform case-insensitive comparison
+            lower_user_roles = {n.lower() for n in user_role_names}
+            if normalized and not (lower_user_roles & normalized):
+                abort(403)
@@
     return decorator
+
+# ---------------------------------------------------------------------------
+# Re-export helper functions from erp.utils for unified security interface
+# ---------------------------------------------------------------------------
+try:
+    from erp.utils import (
+        hash_password,
+        verify_password,
+        login_required as utils_login_required,
+        mfa_required,
+        idempotency_key_required,
+        idempotent,
+        task_idempotent,
+        dead_letter_handler,
+        sanitize_direction,
+        sanitize_sort,
+        stream_export,
+    )
+except Exception:
+    # In minimal environments, some helpers may not be available
+    pass
+
+__all__ = [
+    "require_login",
+    "require_roles",
+    "apply_security",
+    # re-exported helpers
+    "hash_password",
+    "verify_password",
+    "mfa_required",
+    "idempotency_key_required",
+    "idempotent",
+    "task_idempotent",
+    "dead_letter_handler",
+    "sanitize_direction",
+    "sanitize_sort",
+    "stream_export",
+]
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/routes/hr.py
@@
-from flask_login import login_required
+from erp.security import require_roles
@@
-@bp.route("/", methods=["GET", "POST"])
-@login_required
-def index():
+@bp.route("/", methods=["GET", "POST"])
+@require_roles("hr", "admin")
+def index():
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/routes/orders.py
@@
-from flask_login import login_required
+from erp.security import require_roles
@@
-@bp.route("/", methods=["GET", "POST"])
-@login_required
-def index():
+@bp.route("/", methods=["GET", "POST"])
+@require_roles("sales", "admin")
+def index():
@@
-@bp.patch("/<int:order_id>")
-@login_required
-def update(order_id: int):
+@bp.patch("/<int:order_id>")
+@require_roles("sales", "admin")
+def update(order_id: int):
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/routes/maintenance.py
@@
-from flask_login import login_required
+from erp.security import require_roles
@@
-@bp.route("/tickets", methods=["GET", "POST"])
-@login_required
-def tickets():
+@bp.route("/tickets", methods=["GET", "POST"])
+@require_roles("maintenance", "admin")
+def tickets():
@@
-@bp.patch("/tickets/<int:ticket_id>")
-@login_required
-def update_ticket(ticket_id: int):
+@bp.patch("/tickets/<int:ticket_id>")
+@require_roles("maintenance", "admin")
+def update_ticket(ticket_id: int):
@@
-@bp.post("/devices/<int:ticket_id>/heartbeat")
-@login_required
-def geo_heartbeat(ticket_id: int):
+@bp.post("/devices/<int:ticket_id>/heartbeat")
+@require_roles("maintenance", "admin")
+def geo_heartbeat(ticket_id: int):
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/marketing/routes.py
@@
-from flask_login import login_required
-from erp.utils import resolve_org_id, role_required
+from erp.security import require_login, require_roles
+from erp.utils import resolve_org_id
+from erp.extensions import limiter
@@
-@bp.route("/visits", methods=["GET", "POST"])
-@login_required
-@role_required("Staff", "Manager", "Admin")
-def visits():
+@bp.route("/visits", methods=["GET", "POST"])
+@require_roles("staff", "manager", "admin")
+@limiter.limit("20/minute")
+def visits():
@@
-@bp.route("/events", methods=["GET", "POST"])
-@login_required
-@role_required("Manager", "Admin")
-def events():
+@bp.route("/events", methods=["GET", "POST"])
+@require_roles("manager", "admin")
+@limiter.limit("10/minute")
+def events():
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/routes/analytics.py
@@
-from flask import Blueprint, jsonify, request
+from flask import Blueprint, jsonify, request
@@
-from erp.analytics import DemandForecaster
-from erp.extensions import db
+from erp.analytics import DemandForecaster
+from erp.extensions import db, limiter
@@
-from erp.utils import resolve_org_id, utc_now
+from erp.utils import resolve_org_id, utc_now
+from erp.security import require_login
@@
-@bp.post("/vitals")
-def collect_vitals():
+@bp.post("/vitals")
+@limiter.limit("60/minute")
+@require_login
+def collect_vitals():
@@
-@bp.get("/dashboard")
-def dashboard_snapshot():
+@bp.get("/dashboard")
+@limiter.limit("10/minute")
+@require_login
+def dashboard_snapshot():
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/supplychain/routes.py
@@
-from flask_login import login_required
+from erp.security import require_roles
@@
-@supply_bp.route("/policy", methods=["GET", "POST"])
-@login_required
-def policy():
+@supply_bp.route("/policy", methods=["GET", "POST"])
+@require_roles("manager", "admin")
+def policy():
@@
-@supply_bp.route("/shipments", methods=["GET", "POST"])
-@login_required
-def shipments():
+@supply_bp.route("/shipments", methods=["GET", "POST"])
+@require_roles("manager", "admin")
+def shipments():
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/routes/admin.py
@@
-from erp.utils import login_required, mfa_required, sanitize_sort, sanitize_direction
+from erp.security import require_login, mfa_required, sanitize_sort, sanitize_direction, require_roles
@@
-@bp.route("/workflows", methods=["GET", "POST"])
-@login_required
-@mfa_required
-def workflows():
+@bp.route("/workflows", methods=["GET", "POST"])
+@require_roles("admin")
+@mfa_required
+def workflows():
@@
-@bp.route("/panel")
-@login_required
-@mfa_required
-def panel():
+@bp.route("/panel")
+@require_roles("admin")
+@mfa_required
+def panel():
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/user_management/__init__.py
@@
-from flask_login import login_required
+from erp.security import require_roles
@@
-@bp.route("/", methods=["GET", "POST"])
-@login_required
-def index():
+@bp.route("/", methods=["GET", "POST"])
+@require_roles("admin")
+def index():
@@
-@bp.post("/clients/<int:client_id>/approve")
-@login_required
-def approve_client(client_id: int):
+@bp.post("/clients/<int:client_id>/approve")
+@require_roles("admin")
+def approve_client(client_id: int):
@@
-@bp.post("/clients/<int:client_id>/reject")
-@login_required
-def reject_client(client_id: int):
+@bp.post("/clients/<int:client_id>/reject")
+@require_roles("admin")
+def reject_client(client_id: int):
@@
-@bp.post("/users/<int:user_id>/delete")
-@login_required
-def delete_user(user_id: int):
+@bp.post("/users/<int:user_id>/delete")
+@require_roles("admin")
+def delete_user(user_id: int):
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: bots/telegram_bot.py
@@
-from flask import request
-
-def telegram_webhook():
-    data = request.json
-    return "Handled"
+"""
+Telegram bot webhook handler. Delegates message processing to the Telegram webhook blueprint.
+"""
+from flask import request
+from erp.blueprints.telegram_webhook import webhook as _telegram_webhook
+
+def telegram_webhook():
+    """
+    Proxy the Telegram webhook to the blueprint implementation.
+    This ensures consistent processing of chat commands and user validation.
+    """
+    # Directly call the blueprint function
+    response = _telegram_webhook()
+    return response
*** End Patch
*** End Patch

*** Begin Patch
*** Update File: erp/blueprints/telegram_webhook.py
@@
-from flask import Blueprint, request, jsonify
+from flask import Blueprint, request, jsonify
+from erp.extensions import limiter
@@
-@bp.post("/webhook")
-def webhook():
+@bp.post("/webhook")
+@limiter.limit("5/second")
+def webhook():
*** End Patch
*** End Patch
