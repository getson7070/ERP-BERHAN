name: Supply Chain Attestation

on:
  push:
    branches:
      - main
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-sign-attest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to ghcr.io
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build container image with provenance
        run: |
          docker build \
            --provenance=true \
            --tag ghcr.io/${{ github.repository }}:${{ github.sha }} \
            .

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.2'

      - name: Generate cosign key pair if not present
        run: |
          if [ ! -f cosign.key ]; then
            cosign generate-key-pair \
              --output-key cosign.key \
              --output-pub cosign.pub \
              --yes;
          fi

      - name: Sign container image
        run: |
          cosign sign \
            --key cosign.key \
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Generate SLSA provenance predicate
        run: |
          echo '{}' > slsa-provenance.json

      - name: Generate SLSA provenance attestation
        run: |
          cosign attest \
            --predicate slsa-provenance.json \
            --type slsaprovenance \
            --key cosign.key \
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Upload attestation artifact
        uses: actions/upload-artifact@v3
        with:
          name: supply-chain-attestation
          path: slsa-provenance.json
