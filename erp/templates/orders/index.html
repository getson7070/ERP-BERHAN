{% extends 'base.html' %}
{% block title %}Orders{% endblock %}
{% block header %}Orders{% endblock %}

{% block content %}
<section class="container my-4" aria-label="Orders list">
  <div class="card shadow-sm">
    <div class="card-body">
      <form class="row g-2 mb-3" method="get">
        <div class="col-12 col-md-4">
          <label for="q" class="form-label small mb-1">Search</label>
          <input type="text"
                 id="q"
                 name="q"
                 class="form-control form-control-sm"
                 value="{{ request.args.get('q', '') }}"
                 placeholder="Order ID, customer, notes…">
        </div>

        <div class="col-6 col-md-3">
          <label for="status" class="form-label small mb-1">Status</label>
          {% set status = request.args.get('status', '') %}
          <select id="status" name="status" class="form-select form-select-sm">
            <option value="">Any</option>
            {% for s in ['submitted', 'approved', 'invoiced', 'delivered', 'paid', 'settled', 'pending', 'shipped', 'fulfilled', 'canceled', 'rejected'] %}
              <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s|capitalize }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary btn-sm w-100">
            Filter
          </button>
        </div>
      </form>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Status</th>
              <th scope="col">Amount</th>
              <th scope="col">Payment</th>
              <th scope="col">Commission</th>
              <th scope="col">Rep</th>
              <th scope="col">Location</th>
              <th scope="col">Currency</th>
              <th scope="col">Placed at</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders or [] %}
              <tr>
                <td>#{{ o.id }}</td>
                <td>
                  <div class="d-flex flex-column">
                    <span class="badge bg-secondary text-capitalize w-auto">{{ o.status }}</span>
                    <small class="text-muted">Initiator: {{ o.initiator_type or 'unknown' }}</small>
                  </div>
                </td>
                <td>{{ "%.2f"|format(o.total_amount or 0) }}</td>
                <td>
                  <span class="badge bg-light text-dark border">{{ (o.payment_status or 'unpaid')|capitalize }}</span>
                </td>
                <td>
                  <div class="d-flex flex-column small">
                    <span class="badge bg-secondary text-capitalize align-self-start">{{ o.commission_status or 'none' }}</span>
                    {% if o.commission_enabled %}
                      <span class="text-muted">{{ "%.2f"|format((o.commission_amount or 0)) }} at {{ (o.commission_rate or 0) *100 }}%</span>
                      {% if o.commission_block_reason %}
                        <span class="text-danger">{{ o.commission_block_reason }}</span>
                      {% endif %}
                      {% if o.commission_approved_by_management %}
                        <span class="text-success">Management approved</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">Not enabled</span>
                    {% endif %}
                  </div>
                </td>
                <td>{{ o.assigned_sales_rep.username if o.assigned_sales_rep else 'Unassigned' }}</td>
                <td>
                  {% set has_geo = o.geo_lat is not none and o.geo_lng is not none %}
                  {% if has_geo %}
                    <div class="d-flex flex-column">
                      <span class="fw-semibold small">{{ "%.5f"|format(o.geo_lat) }}, {{ "%.5f"|format(o.geo_lng) }}</span>
                      {% if o.geo_accuracy_m %}
                        <small class="text-muted">Accuracy ±{{ "%.1f"|format(o.geo_accuracy_m) }} m</small>
                      {% endif %}
                      {% if o.geo_recorded_at %}
                        <small class="text-muted">Captured {{ o.geo_recorded_at }}</small>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="badge bg-warning text-dark">Geo required</span>
                    <small class="d-block text-muted">Capture location at creation/approval.</small>
                  {% endif %}
                </td>
                <td>{{ o.currency or 'ETB' }}</td>
                <td><small class="text-muted">{{ o.placed_at }}</small></td>
                <td class="text-end">
                  <a href="{{ url_for('orders.detail', order_id=o.id) }}"
                     class="btn btn-outline-secondary btn-sm">
                    View
                  </a>
                  <button type="button"
                          class="btn btn-outline-primary btn-sm"
                          data-order-id="{{ o.id }}"
                          data-action="request-approval">
                    Request approval
                  </button>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="9" class="text-center text-muted py-3">
                  No orders found for the current filters.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script>
    (function () {
      const buttons = document.querySelectorAll('button[data-action="request-approval"]');
      if (!buttons.length) return;

      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          const orderId = btn.getAttribute("data-order-id");
          if (!orderId) return;

          // TODO: wire this to your real approvals endpoint
          const url = "/approvals/orders/" + orderId + "/request";
          if (!confirm("Request approval for order #" + orderId + "?")) return;

          fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token()|e }}"
            },
            body: JSON.stringify({})
          })
          .then(function (resp) {
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            return resp.json();
          })
          .then(function () {
            alert("Approval request sent.");
          })
          .catch(function (err) {
            console.error("Approval request failed", err);
            alert("Could not request approval. Check console/logs.");
          });
        });
      });
    })();
  </script>
{% endblock %}

