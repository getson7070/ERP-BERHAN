{% extends "base.html" %}
{% block title %}Tenders{% endblock %}
{% block content %}
  <header class="page-header">
    <h1 class="page-title">Tender lifecycle</h1>
    <p class="page-subtitle">Monitor tender progress and capture evaluation outcomes.</p>
    <div class="button-grid">
      <a class="btn btn--secondary" href="{{ url_for('tenders.add_tender') }}">Register tender</a>
      <a class="btn btn--ghost" href="{{ url_for('tenders.tenders_report') }}">Full report</a>
      <a class="btn btn--ghost" href="{{ url_for('tenders.export_tenders_csv', sort=sort, dir=direction) }}">Export CSV</a>
      <a class="btn btn--ghost" href="{{ url_for('tenders.export_tenders_xlsx', sort=sort, dir=direction) }}">Export XLSX</a>
    </div>
  </header>
  {% if tenders %}
    <div class="table-responsive">
      <table class="table tenders-table">
        <thead>
          <tr>
            <th scope="col"><a href="{{ url_for('tenders.tenders_list', sort='due_date', dir='asc' if sort != 'due_date' or direction == 'desc' else 'desc', limit=limit) }}">Due date</a></th>
            <th scope="col">Tender</th>
            <th scope="col">Type</th>
            <th scope="col">Institution</th>
            <th scope="col">Envelope</th>
            <th scope="col">Workflow state</th>
            <th scope="col">Owner</th>
            <th scope="col" class="tenders-table__actions">Next action</th>
          </tr>
        </thead>
        <tbody>
          {% for tender in tenders %}
            {% set state = tender.workflow_state %}
            <tr>
              <td data-title="Due date">{{ tender.due_date }}</td>
              <td data-title="Tender">{{ tender.description }}</td>
              <td data-title="Type">{{ tender.type_name }}</td>
              <td data-title="Institution">{{ tender.institution }}</td>
              <td data-title="Envelope">{{ tender.envelope_type }}</td>
              <td data-title="Workflow state"><span class="status-chip">{{ state.replace('_', ' ')|title }}</span></td>
              <td data-title="Owner">{{ tender.username }}</td>
              <td data-title="Next action" class="tenders-table__actions">
                {% if state == 'awarded' %}
                  <p class="status-note">Awarded to {{ tender.awarded_to or '—' }} on {{ tender.award_date or '—' }}</p>
                {% else %}
                  <form method="post" action="{{ url_for('tenders.advance_tender', tender_id=tender.id) }}" class="form-grid form-grid--inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if state == 'opening_minute' %}
                      <label class="form-checkbox">
                        <input type="checkbox" name="evaluation_complete" value="1" class="form-checkbox__input">
                        <span class="form-checkbox__label">Evaluation complete</span>
                      </label>
                      <button type="submit" class="btn btn--primary">Mark evaluated</button>
                    {% elif state == 'evaluated' %}
                      <div class="form-field">
                        <label class="form-label" for="result-{{ tender.id }}">Result</label>
                        <select id="result-{{ tender.id }}" name="result" class="form-input">
                          <option value="won">Won</option>
                          <option value="defeat">Defeat</option>
                          <option value="rejected">Rejected</option>
                          <option value="cancelled">Cancelled</option>
                        </select>
                      </div>
                      <div class="form-field">
                        <label class="form-label" for="awarded-to-{{ tender.id }}">Awarded to</label>
                        <input id="awarded-to-{{ tender.id }}" name="awarded_to" class="form-input" placeholder="Awarded organization">
                      </div>
                      <div class="form-field">
                        <label class="form-label" for="award-date-{{ tender.id }}">Award date</label>
                        <input id="award-date-{{ tender.id }}" name="award_date" type="date" class="form-input">
                      </div>
                      <button type="submit" class="btn btn--primary">Record outcome</button>
                    {% else %}
                      <button type="submit" class="btn btn--primary">Advance to next stage</button>
                    {% endif %}
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <nav class="pagination" aria-label="Tenders pagination">
      <span>Showing {{ tenders|length }} result{{ tenders|length != 1 and 's' or '' }}</span>
      <div class="pagination__actions">
        {% if prev_offset is not none %}
          <a class="btn btn--ghost" href="{{ url_for('tenders.tenders_list', offset=prev_offset, limit=limit, sort=sort, dir=direction) }}">Previous</a>
        {% endif %}
        {% if next_offset is not none %}
          <a class="btn btn--ghost" href="{{ url_for('tenders.tenders_list', offset=next_offset, limit=limit, sort=sort, dir=direction) }}">Next</a>
        {% endif %}
      </div>
    </nav>
  {% else %}
    <p class="empty-state">No tenders registered yet.</p>
  {% endif %}
{% endblock %}
{% block head %}
  {{ super() }}
  <style>
    .table-responsive { margin-top: var(--space-xl); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: var(--space-md); border-bottom: 1px solid var(--border-subtle); text-align: left; vertical-align: top; }
    .table th a { color: inherit; text-decoration: none; }
    .table th a:hover { text-decoration: underline; }
    .tenders-table__actions { min-width: 260px; }
    .status-chip { display: inline-flex; padding: 0 var(--space-sm); border-radius: 999px; background: var(--layer-muted); font-weight: 600; font-size: 0.85rem; }
    .form-grid--inline { display: grid; gap: var(--space-sm); }
    .status-note { font-size: 0.9rem; color: var(--text-muted); margin: 0; }
    .pagination { display: flex; justify-content: space-between; align-items: center; gap: var(--space-sm); margin-top: var(--space-md); flex-wrap: wrap; }
    .pagination__actions { display: flex; gap: var(--space-sm); }
    .empty-state { margin-top: var(--space-xl); padding: var(--space-lg); background: var(--layer-subtle); border-radius: var(--radius-md); text-align: center; color: var(--text-muted); }
  </style>
{% endblock %}
