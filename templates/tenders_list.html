{% extends 'base.html' %}
{% block title %}Tenders{% endblock %}
{% block content %}
<style>
  :focus { outline: 2px dashed #4f46e5; outline-offset: 2px; }
  .table-sticky thead th { position: sticky; top: 0; background: #fff; }
</style>
<div class="container py-5">
    <h2>Tenders</h2>
    <div class="mb-2">
        <span class="me-2">Columns:</span>
        <input type="checkbox" id="col-result" class="col-toggle" data-col="5" checked>
        <label for="col-result" class="me-2">Result</label>
        <input type="checkbox" id="col-awarded" class="col-toggle" data-col="6" checked>
        <label for="col-awarded" class="me-2">Awarded To</label>
        <input type="checkbox" id="col-inst" class="col-toggle" data-col="9" checked>
        <label for="col-inst" class="me-2">Institution</label>
    </div>
    <p>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('tenders.export_tenders_csv', sort=sort, dir=direction) }}">CSV</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('tenders.export_tenders_xlsx', sort=sort, dir=direction) }}">XLSX</a>
    </p>
    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% if tenders %}
    <div class="table-responsive">
    <table class="table table-striped table-sticky">
        <thead>
            <tr>
                <th aria-sort="{{ 'ascending' if sort=='id' and direction=='asc' else 'descending' if sort=='id' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='id', dir='desc' if sort=='id' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">ID{% if sort=='id' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='type_name' and direction=='asc' else 'descending' if sort=='type_name' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='type_name', dir='desc' if sort=='type_name' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Type{% if sort=='type_name' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='description' and direction=='asc' else 'descending' if sort=='description' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='description', dir='desc' if sort=='description' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Description{% if sort=='description' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='due_date' and direction=='asc' else 'descending' if sort=='due_date' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='due_date', dir='desc' if sort=='due_date' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Due Date{% if sort=='due_date' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='workflow_state' and direction=='asc' else 'descending' if sort=='workflow_state' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='workflow_state', dir='desc' if sort=='workflow_state' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">State{% if sort=='workflow_state' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='result' and direction=='asc' else 'descending' if sort=='result' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='result', dir='desc' if sort=='result' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Result{% if sort=='result' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='awarded_to' and direction=='asc' else 'descending' if sort=='awarded_to' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='awarded_to', dir='desc' if sort=='awarded_to' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Awarded To{% if sort=='awarded_to' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='award_date' and direction=='asc' else 'descending' if sort=='award_date' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='award_date', dir='desc' if sort=='award_date' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Award Date{% if sort=='award_date' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='username' and direction=='asc' else 'descending' if sort=='username' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='username', dir='desc' if sort=='username' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">User{% if sort=='username' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='institution' and direction=='asc' else 'descending' if sort=='institution' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='institution', dir='desc' if sort=='institution' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Institution{% if sort=='institution' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th aria-sort="{{ 'ascending' if sort=='envelope_type' and direction=='asc' else 'descending' if sort=='envelope_type' and direction=='desc' else 'none' }}">
                    <a href="{{ url_for('tenders.tenders_list', sort='envelope_type', dir='desc' if sort=='envelope_type' and direction=='asc' else 'asc', offset=offset, limit=limit) }}">Envelope{% if sort=='envelope_type' %}{% if direction=='asc' %} ▲{% else %} ▼{% endif %}{% endif %}</a>
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for tender in tenders %}
            <tr>
                <td>{{ tender['id'] }}</td>
                <td>{{ tender['type_name'] }}</td>
                <td>{{ tender['description'] }}</td>
                <td>{{ tender['due_date'] }}</td>
                <td>{{ tender['workflow_state'].replace('_', ' ') }}</td>
                <td>{{ tender['result'] if tender['result'] else '—' }}</td>
                <td>{{ tender['awarded_to'] or '—' }}</td>
                <td>{{ tender['award_date'] or '—' }}</td>
                <td>{{ tender['username'] }}</td>
                <td>{{ tender['institution'] or 'N/A' }}</td>
                <td>{{ tender['envelope_type'] }}</td>
                <td>
                    {% if tender['workflow_state'] == 'opening_minute' %}
                    <form method="post" action="{{ url_for('tenders.advance_tender', tender_id=tender['id']) }}" class="needs-validation" novalidate>
                        <input type="hidden" name="evaluation_complete" value="1">
                        <button type="submit" class="btn btn-sm btn-primary">Mark Evaluated</button>
                    </form>
                    {% elif tender['workflow_state'] == 'evaluated' %}
                    <form method="post" action="{{ url_for('tenders.advance_tender', tender_id=tender['id']) }}" class="row g-1 needs-validation" novalidate>
                        <div class="col-auto">
                            <label for="result-{{ tender['id'] }}" class="visually-hidden">Result</label>
                            <select id="result-{{ tender['id'] }}" name="result" class="form-select form-select-sm">
                                <option value="won">Won</option>
                                <option value="defeat">Defeat</option>
                                <option value="rejected">Rejected</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col">
                            <label for="awarded-{{ tender['id'] }}" class="visually-hidden">Awarded To</label>
                            <input type="text" id="awarded-{{ tender['id'] }}" name="awarded_to" class="form-control form-control-sm" placeholder="Awarded To">
                        </div>
                        <div class="col">
                            <label for="award-date-{{ tender['id'] }}" class="visually-hidden">Award Date</label>
                            <input type="date" id="award-date-{{ tender['id'] }}" name="award_date" class="form-control form-control-sm">
                        </div>
                        <div class="col-auto"><button type="submit" class="btn btn-sm btn-primary">Record</button></div>
                    </form>
                    {% else %}
                    —
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <nav>
        <ul class="pagination">
            {% if prev_offset is not none %}
            <li class="page-item"><a class="page-link" href="{{ url_for('tenders.tenders_list', offset=prev_offset, limit=limit, sort=sort, dir=direction) }}">Previous</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}
            {% if next_offset is not none %}
            <li class="page-item"><a class="page-link" href="{{ url_for('tenders.tenders_list', offset=next_offset, limit=limit, sort=sort, dir=direction) }}">Next</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
    {% else %}
    <p>No tenders yet — <a href="{{ url_for('tenders.add_tender') }}">Add Tender</a></p>
    {% endif %}
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Back</a>
</div>
<script>
  document.querySelectorAll('.col-toggle').forEach(cb => {
    cb.addEventListener('change', () => {
      const idx = parseInt(cb.dataset.col);
      document.querySelectorAll('.table tr').forEach(row => {
        const cell = row.children[idx];
        if(cell){ cell.style.display = cb.checked ? '' : 'none'; }
      });
    });
  });
</script>
{% endblock %}
