{% extends 'base.html' %}
{% block title %}Tenders{% endblock %}
{% block body %}
<div class="container mt-4">
    <h2>Tenders</h2>
    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% if tenders %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>State</th>
                <th>Result</th>
                <th>Awarded To</th>
                <th>Award Date</th>
                <th>User</th>
                <th>Institution</th>
                <th>Envelope</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for tender in tenders %}
            <tr>
                <td>{{ tender['id'] }}</td>
                <td>{{ tender['type_name'] }}</td>
                <td>{{ tender['description'] }}</td>
                <td>{{ tender['due_date'] }}</td>
                <td>{{ tender['workflow_state'].replace('_', ' ') }}</td>
                <td>{{ tender['result'] if tender['result'] else '—' }}</td>
                <td>{{ tender['awarded_to'] or '—' }}</td>
                <td>{{ tender['award_date'] or '—' }}</td>
                <td>{{ tender['user'] }}</td>
                <td>{{ tender['institution'] or 'N/A' }}</td>
                <td>{{ tender['envelope_type'] }}</td>
                <td>
                    {% if tender['workflow_state'] == 'opening_minute' %}
                    <form method="post" action="{{ url_for('tenders.advance_tender', tender_id=tender['id']) }}">
                        <input type="hidden" name="evaluation_complete" value="1">
                        <button type="submit" class="btn btn-sm btn-primary">Mark Evaluated</button>
                    </form>
                    {% elif tender['workflow_state'] == 'evaluated' %}
                    <form method="post" action="{{ url_for('tenders.advance_tender', tender_id=tender['id']) }}" class="row g-1">
                        <div class="col-auto">
                            <select name="result" class="form-select form-select-sm">
                                <option value="won">Won</option>
                                <option value="defeat">Defeat</option>
                                <option value="rejected">Rejected</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col"><input type="text" name="awarded_to" class="form-control form-control-sm" placeholder="Awarded To"></div>
                        <div class="col"><input type="date" name="award_date" class="form-control form-control-sm"></div>
                        <div class="col-auto"><button type="submit" class="btn btn-sm btn-primary">Record</button></div>
                    </form>
                    {% else %}
                    —
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No tenders found.</p>
    {% endif %}
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Back</a>
</div>
{% endblock %}

