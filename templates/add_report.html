<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Add Marketing Report</h2>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endwith %}
        {% endif %}
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                <label for="institution" class="form-label">Institution</label>
                <select name="institution" id="institution" class="form-select" required onchange="toggleNewInstitution()">
                    <option value="">Select Institution</option>
                    {% for institution in institutions %}
                        <option value="{{ institution }}">{{ institution }}</option>
                    {% endfor %}
                    <option value="new">New Institution</option>
                </select>
            </div>
            <div class="mb-3" id="new_institution_field" style="display: none;">
                <label for="new_institution" class="form-label">New Institution Name</label>
                <input type="text" name="new_institution" id="new_institution" class="form-control">
            </div>
            <div class="mb-3">
                <label for="region" class="form-label">Region</label>
                <select name="region" id="region" class="form-select" required onchange="updateCities()">
                    <option value="">Select Region</option>
                    {% for region in regions %}
                        <option value="{{ region }}">{{ region }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="city" class="form-label">City/Town</label>
                <select name="city" id="city" class="form-select">
                    <option value="">Select City/Town</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="location_detail" class="form-label">Location Detail</label>
                <input type="text" name="location_detail" id="location_detail" class="form-control">
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone</label>
                <input type="text" name="phone" id="phone" class="form-control" pattern="^(09|07)\d{8}$" title="Must be a 10-digit number starting with 09 or 07" required>
            </div>
            <div class="mb-3">
                <label for="visit_date" class="form-label">Visit Date</label>
                <input type="date" name="visit_date" id="visit_date" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Products</label>
                {% for category, products in products.items() %}
                    <h5>{{ category }}</h5>
                    {% for product in products %}
                        <div class="form-check">
                            <input type="checkbox" name="products" value="{{ product }}" class="form-check-input" onchange="toggleOtherDetail()">
                            <label class="form-check-label">{{ product }}</label>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            <div class="mb-3" id="other_detail_field" style="display: none;">
                <label for="other_detail" class="form-label">Other Product Details</label>
                <input type="text" name="other_detail" id="other_detail" class="form-control">
            </div>
            <div class="mb-3">
                <label for="outcome" class="form-label">Outcome</label>
                <select name="outcome" id="outcome" class="form-select" required>
                    <option value="Sale" selected>Sale</option>
                    <option value="Contract">Contract</option>
                    <option value="Negotiation">Negotiation</option>
                    <option value="No Interest">No Interest</option>
                </select>
            </div>
            <div class="mb-3" id="sale_amount_field" style="display: block;">
                <label for="sale_amount" class="form-label">Sale Amount (ETB)</label>
                <input type="number" name="sale_amount" id="sale_amount" class="form-control" min="0">
            </div>
            <div class="mb-3">
                <label for="visit_type" class="form-label">Visit Type</label>
                <select name="visit_type" id="visit_type" class="form-select" required>
                    <option value="First Visit">First Visit</option>
                    <option value="Follow-up">Follow-up</option>
                </select>
            </div>
            <div class="mb-3" id="follow_up_field" style="display: none;">
                <label for="follow_up" class="form-label">Follow-up Details</label>
                <input type="text" name="follow_up" id="follow_up" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary ms-2">Back to Dashboard</a>
        </form>
    </div>
    <script>
        function toggleNewInstitution() {
            var institution = document.getElementById('institution').value;
            document.getElementById('new_institution_field').style.display = institution === 'new' ? 'block' : 'none';
        }

        function updateCities() {
            var region = document.getElementById('region').value;
            var citySelect = document.getElementById('city');
            citySelect.innerHTML = '<option value="">Select City/Town</option>';
            if (region) {
                fetch(`/get_cities?region=${region}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(city => {
                            var option = document.createElement('option');
                            option.value = city;
                            option.text = city;
                            citySelect.appendChild(option);
                        });
                    });
            }
        }

        function toggleOtherDetail() {
            var othersChecked = document.querySelector('input[name="products"][value="OTHERS"]').checked;
            document.getElementById('other_detail_field').style.display = othersChecked ? 'block' : 'none';
        }

        document.getElementById('outcome').addEventListener('change', function() {
            document.getElementById('sale_amount_field').style.display = this.value === 'Sale' ? 'block' : 'none';
        });

        document.getElementById('visit_type').addEventListener('change', function() {
            document.getElementById('follow_up_field').style.display = this.value === 'Follow-up' ? 'block' : 'none';
        });

        // Initialize states
        toggleNewInstitution();
        toggleOtherDetail();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>