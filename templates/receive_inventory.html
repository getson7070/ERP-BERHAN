{% extends "base.html" %}
{% block title %}Receive Inventory{% endblock %}
{% block body %}
{% include "partials/navbar.html" %}
<div class="container py-5">
  {% set crumbs=[{'title': _('Home'), 'url': url_for('dashboard')}, {'title': _('Receive Inventory')}] %}
  {% include 'partials/breadcrumbs.html' %}
  <h2>Receive Inventory {% include 'partials/help_tooltip.html' %}</h2>
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}
  <div id="scanner" class="mb-3"></div>
  <div id="qr-reader" class="mb-3"></div>
  <form method="POST" action="" class="needs-validation" novalidate>
    {{ form.hidden_tag() }}
    <div class="mb-3">
      <label for="item_id" class="form-label">Item</label>
      <select name="item_id" id="item_id" class="form-select" required>
        {% for item in items %}
          <option value="{{ item['id'] }}">{{ item['item_code'] }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="quantity" class="form-label">Quantity</label>
      <input type="number" name="quantity" id="quantity" class="form-control" min="1" required>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary ms-2">Back to Dashboard</a>
  </form>
</div>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js" integrity="sha384-sl2LNalPRD3qrS3TKmINXWwRcQKf9cUlNZGd8pqjlpzwbzgMsFgE+133u4kM32IR" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js" integrity="sha384-esTT3pUoxT1ABdxNxbMOglzErtD7TMAJIeNSgB/6zIc15mCDJBQ47WIQWsP6v+Pb" crossorigin="anonymous"></script>
  <script>
  const scanner = document.getElementById('scanner');
  if (scanner) {
    Quagga.init({
      inputStream: { name: 'Live', type: 'LiveStream', target: scanner },
      decoder: { readers: ['code_128_reader'] }
    }, function(err){
      if (!err) { Quagga.start(); }
    });
    Quagga.onDetected(async data => {
      const code = data.codeResult.code;
      try {
        const resp = await fetch('/inventory/receive/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode: code })
        });
        const result = await resp.json();
        showMessage(result.valid ? 'success' : 'danger', result.valid ? 'Barcode valid' : 'Invalid barcode');
      } catch (err) {
        showMessage('danger', 'Verification failed');
      }
      Quagga.stop();
    });
  }

  const qrEl = document.getElementById('qr-reader');
  if (qrEl) {
    const qrScanner = new Html5Qrcode('qr-reader');
    qrScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 }, async text => {
      try {
        const resp = await fetch('/inventory/receive/verify_qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qr_data: text })
        });
        const result = await resp.json();
        showMessage(result.valid ? 'success' : 'danger', result.valid ? 'QR code valid' : 'Invalid QR code');
      } catch (err) {
        showMessage('danger', 'Verification failed');
      }
      qrScanner.stop();
    });
  }
  </script>
{% endblock %}
