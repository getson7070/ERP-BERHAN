# Supply Chain Security & Attestation

This document explains how ERP-BERHAN publishes signed container images together with SLSA Level 3 provenance and how operators can verify those artifacts before deployment.

## Build & Signing Pipeline

The `supply-chain-attestation` GitHub Actions workflow performs the following steps on every push to `main` and on published releases:

1. **Deterministic container build** – Docker Buildx builds the image for `linux/amd64`, pushes it to `ghcr.io/<owner>/<repo>`, and captures the resulting image digest and build metadata.
2. **Keyless image signature** – Cosign authenticates to GitHub Container Registry using OIDC and signs the immutable digest via keyless Sigstore identities, ensuring the signature is anchored in the Rekor transparency log.
3. **SLSA provenance generation** – The workflow delegates to [`slsa-framework/slsa-github-generator`](https://github.com/slsa-framework/slsa-github-generator) to emit an in-toto predicate that records the builder digest, source repository, materials, and build parameters. The predicate is published back to the registry alongside the image.
4. **Continuous verification** – After provenance upload, the workflow uses `cosign verify-attestation` to assert that the stored predicate is signed by the official SLSA generator reusable workflow and bound to the built digest.

The resulting supply-chain evidence (image signature and provenance predicate) is discoverable directly from GHCR clients and transparency logs.

## Verifying Published Images

Consumers should verify both the image signature and the attested provenance before promotion or deployment.

### 1. Verify the image signature

```bash
cosign verify \
  --keyless \
  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
  ghcr.io/getson7070/ERP-BERHAN@sha256:<digest>
```

Successful verification confirms the digest was signed by a GitHub Actions workflow using Sigstore's keyless flow. Replace `<digest>` with the image digest you intend to deploy (for example, the SHA recorded in your deployment manifest).

### 2. Verify the SLSA provenance attestation

```bash
cosign verify-attestation \
  --keyless \
  --type slsaprovenance \
  --certificate-identity "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v2.1.0" \
  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
  ghcr.io/getson7070/ERP-BERHAN@sha256:<digest>
```

The command fetches the SLSA predicate bound to the digest and ensures it was generated by the trusted reusable workflow. To inspect the predicate contents, append `| jq -r '.payload' | base64 --decode | jq` to decode and view fields such as:

- `predicate.builder.id` – identifies the SLSA generator workflow.
- `predicate.buildDefinition.externalParameters.source.uri` – shows the Git repository and commit used for the build.
- `predicate.materials[]` – enumerates inputs (e.g., container base image digests).

These values should match the commit and dependencies you expect to promote.

### 3. Rekor transparency verification (optional)

Cosign automatically records signatures and attestations in the Rekor transparency log. To audit the log entry, capture the UUID from the verification output and query Rekor:

```bash
rekor-cli get --uuid <uuid>
```

This provides an immutable audit trail proving when and by whom the artifact was signed.

## Operational Expectations

- Always reference images by digest when promoting to staging or production so that attestation verification covers the exact artifact you deploy.
- Keep Cosign upgraded to v2.2.2 or newer to ensure support for Sigstore keyless workflows and SLSA predicates.
- Environments that mirror images should mirror the accompanying attestation as well; GHCR exposes these through the `application/vnd.in-toto+json` media type.
- Any modifications to the build pipeline must maintain provenance generation and verification. Pull requests altering `.github/workflows/supply-chain-attestation.yml` must document equivalent security guarantees.

For a walkthrough of the workflow run, review the latest run of **Supply Chain Attestation** in GitHub Actions; the logs include the captured digest, signing identity, and verification results.
